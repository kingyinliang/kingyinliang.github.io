<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Koa | kingyingliang</title>
    <meta name="description" content="kingyingliang的个人博客">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.2868158a.css" as="style"><link rel="preload" href="/assets/js/app.8b298d71.js" as="script"><link rel="preload" href="/assets/js/3.1047f7fc.js" as="script"><link rel="preload" href="/assets/js/1.e9036eeb.js" as="script"><link rel="preload" href="/assets/js/12.a94480e8.js" as="script"><link rel="prefetch" href="/assets/js/10.faea7ed6.js"><link rel="prefetch" href="/assets/js/11.a1eb7cb1.js"><link rel="prefetch" href="/assets/js/13.78aa3210.js"><link rel="prefetch" href="/assets/js/14.873f66c8.js"><link rel="prefetch" href="/assets/js/15.90e4a351.js"><link rel="prefetch" href="/assets/js/16.e9797b58.js"><link rel="prefetch" href="/assets/js/17.ae73df78.js"><link rel="prefetch" href="/assets/js/18.63201470.js"><link rel="prefetch" href="/assets/js/19.74ca95e4.js"><link rel="prefetch" href="/assets/js/20.ca975c1c.js"><link rel="prefetch" href="/assets/js/21.03ae9a37.js"><link rel="prefetch" href="/assets/js/22.30d540c3.js"><link rel="prefetch" href="/assets/js/23.4c7ee792.js"><link rel="prefetch" href="/assets/js/24.c286385e.js"><link rel="prefetch" href="/assets/js/25.3dcf4fb6.js"><link rel="prefetch" href="/assets/js/26.136db144.js"><link rel="prefetch" href="/assets/js/27.7f89bba4.js"><link rel="prefetch" href="/assets/js/28.5f2690f1.js"><link rel="prefetch" href="/assets/js/29.e455dd30.js"><link rel="prefetch" href="/assets/js/30.9b5791ce.js"><link rel="prefetch" href="/assets/js/31.8bdbfc59.js"><link rel="prefetch" href="/assets/js/32.c6d259c7.js"><link rel="prefetch" href="/assets/js/33.a52d22d8.js"><link rel="prefetch" href="/assets/js/34.4c6deef9.js"><link rel="prefetch" href="/assets/js/35.b974d0f2.js"><link rel="prefetch" href="/assets/js/36.75dbacb4.js"><link rel="prefetch" href="/assets/js/4.42ba4794.js"><link rel="prefetch" href="/assets/js/5.903262c0.js"><link rel="prefetch" href="/assets/js/6.029a538f.js"><link rel="prefetch" href="/assets/js/7.43e76bc3.js"><link rel="prefetch" href="/assets/js/8.cdc6e064.js"><link rel="prefetch" href="/assets/js/9.21bfb851.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2868158a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.png" alt="kingyingliang" class="logo"> <span class="site-name">kingyingliang</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      前端技术
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>规范</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/standard/HTML.html" class="nav-link"><i class="iconfont undefined"></i>
  HTML
</a></li><li class="dropdown-subitem"><a href="/standard/CSS.html" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-subitem"><a href="/standard/JS.html" class="nav-link"><i class="iconfont undefined"></i>
  JS
</a></li><li class="dropdown-subitem"><a href="/standard/GIT.html" class="nav-link"><i class="iconfont undefined"></i>
  GIT
</a></li><li class="dropdown-subitem"><a href="/standard/TEST.html" class="nav-link"><i class="iconfont undefined"></i>
  测试
</a></li><li class="dropdown-subitem"><a href="/standard/workflow.html" class="nav-link"><i class="iconfont undefined"></i>
  工作流
</a></li><li class="dropdown-subitem"><a href="/standard/wepy.html" class="nav-link"><i class="iconfont undefined"></i>
  小程序
</a></li></ul></li><li class="dropdown-item"><h4>技术</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Technology/Nuxt/" class="nav-link"><i class="iconfont undefined"></i>
  Nuxt
</a></li><li class="dropdown-subitem"><a href="/Technology/Nesxt/" class="nav-link"><i class="iconfont undefined"></i>
  Nesxt微服务
</a></li><li class="dropdown-subitem"><a href="/Technology/Node/" class="nav-link"><i class="iconfont undefined"></i>
  Node
</a></li><li class="dropdown-subitem"><a href="/Technology/Koa/Koa.html" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  Koa
</a></li><li class="dropdown-subitem"><a href="/Technology/React/React.html" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li><li class="dropdown-subitem"><a href="/Technology/Express/Express.html" class="nav-link"><i class="iconfont undefined"></i>
  Express
</a></li><li class="dropdown-subitem"><a href="/Technology/Electron/Electron.html" class="nav-link"><i class="iconfont undefined"></i>
  Electron
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      读书会
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/readingParty/reconsitution/" class="nav-link"><i class="iconfont undefined"></i>
  重构
</a></li><li class="dropdown-item"><!----> <a href="/readingParty/" class="nav-link"><i class="iconfont undefined"></i>
  其他
</a></li></ul></div></div><div class="nav-item"><a href="/share/" class="nav-link"><i class="iconfont reco-other"></i>
  分享
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-three"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></li><li class="dropdown-item"><!----> <a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></li><li class="dropdown-item"><!----> <a href="/category/Tenchnology.html" class="nav-link"><i class="iconfont reco-category"></i>
  分类
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/kingyinliang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      前端技术
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>规范</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/standard/HTML.html" class="nav-link"><i class="iconfont undefined"></i>
  HTML
</a></li><li class="dropdown-subitem"><a href="/standard/CSS.html" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-subitem"><a href="/standard/JS.html" class="nav-link"><i class="iconfont undefined"></i>
  JS
</a></li><li class="dropdown-subitem"><a href="/standard/GIT.html" class="nav-link"><i class="iconfont undefined"></i>
  GIT
</a></li><li class="dropdown-subitem"><a href="/standard/TEST.html" class="nav-link"><i class="iconfont undefined"></i>
  测试
</a></li><li class="dropdown-subitem"><a href="/standard/workflow.html" class="nav-link"><i class="iconfont undefined"></i>
  工作流
</a></li><li class="dropdown-subitem"><a href="/standard/wepy.html" class="nav-link"><i class="iconfont undefined"></i>
  小程序
</a></li></ul></li><li class="dropdown-item"><h4>技术</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Technology/Nuxt/" class="nav-link"><i class="iconfont undefined"></i>
  Nuxt
</a></li><li class="dropdown-subitem"><a href="/Technology/Nesxt/" class="nav-link"><i class="iconfont undefined"></i>
  Nesxt微服务
</a></li><li class="dropdown-subitem"><a href="/Technology/Node/" class="nav-link"><i class="iconfont undefined"></i>
  Node
</a></li><li class="dropdown-subitem"><a href="/Technology/Koa/Koa.html" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  Koa
</a></li><li class="dropdown-subitem"><a href="/Technology/React/React.html" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li><li class="dropdown-subitem"><a href="/Technology/Express/Express.html" class="nav-link"><i class="iconfont undefined"></i>
  Express
</a></li><li class="dropdown-subitem"><a href="/Technology/Electron/Electron.html" class="nav-link"><i class="iconfont undefined"></i>
  Electron
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      读书会
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/readingParty/reconsitution/" class="nav-link"><i class="iconfont undefined"></i>
  重构
</a></li><li class="dropdown-item"><!----> <a href="/readingParty/" class="nav-link"><i class="iconfont undefined"></i>
  其他
</a></li></ul></div></div><div class="nav-item"><a href="/share/" class="nav-link"><i class="iconfont reco-other"></i>
  分享
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-three"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></li><li class="dropdown-item"><!----> <a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></li><li class="dropdown-item"><!----> <a href="/category/Tenchnology.html" class="nav-link"><i class="iconfont reco-category"></i>
  分类
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/kingyinliang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Technology/Koa/Koa.html" class="active sidebar-link">Koa</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-入门" class="sidebar-link">Koa 入门</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-路由" class="sidebar-link">Koa 路由</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#get-传值" class="sidebar-link">get 传值</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#动态路由" class="sidebar-link">动态路由</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#post" class="sidebar-link">post</a></li></ul></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#中间件" class="sidebar-link">中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#应用级中间件" class="sidebar-link">应用级中间件</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#路由中间件" class="sidebar-link">路由中间件</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#错误处理中间" class="sidebar-link">错误处理中间</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#第三方中间件" class="sidebar-link">第三方中间件</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-中间件的执行顺序" class="sidebar-link">Koa 中间件的执行顺序</a></li></ul></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-cookie" class="sidebar-link">Koa Cookie</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#session" class="sidebar-link">Session</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#session-的工作流程" class="sidebar-link">Session 的工作流程</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-session" class="sidebar-link">koa-session</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#cookie-和-session-区别" class="sidebar-link">Cookie 和 Session 区别</a></li></ul></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-static-静态资源中间件" class="sidebar-link">koa-static 静态资源中间件</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa2-cors-跨域" class="sidebar-link">koa2-cors 跨域</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-json" class="sidebar-link">koa-json</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-logger" class="sidebar-link">koa-logger</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#koa-jwt-token中间件" class="sidebar-link">koa-jwt token中间件</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#验证中间件" class="sidebar-link">验证中间件</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#sequelize" class="sidebar-link">sequelize</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#sequelize-连接mysql" class="sidebar-link">sequelize 连接mysql</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#sequelize-auto-生成models" class="sidebar-link">sequelize-auto 生成models</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#生成model关系模型" class="sidebar-link">生成model关系模型</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#sequelize同步模型到数据库" class="sidebar-link">sequelize同步模型到数据库</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#login生成token" class="sidebar-link">login生成token</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#基本sql语句" class="sidebar-link">基本sql语句</a></li><li class="sidebar-sub-header"><a href="/Technology/Koa/Koa.html#使用原生sql" class="sidebar-link">使用原生sql</a></li></ul></li></ul></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>Koa</h1> <hr> <div data-v-cf5504f4><i class="iconfont reco-account" data-v-cf5504f4><span data-v-cf5504f4>kingyinliang</span></i> <i class="iconfont reco-date" data-v-cf5504f4><span data-v-cf5504f4>2019-2-14</span></i> <!----> <i class="iconfont reco-tag tags" data-v-cf5504f4><span class="tag-item" data-v-cf5504f4>
      Koa
    </span></i></div></div> <div class="content__default"><h1 id="koa"><a href="#koa" aria-hidden="true" class="header-anchor">#</a> Koa</h1> <h2 id="koa-入门"><a href="#koa-入门" aria-hidden="true" class="header-anchor">#</a> Koa 入门</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> install--save koa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//引入 Koa </span>
<span class="token keyword">const</span> koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> app<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//配置中间件 （可以先当做路由） </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'hello koa2'</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//监听端口 </span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="koa-路由"><a href="#koa-路由" aria-hidden="true" class="header-anchor">#</a> Koa 路由</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save koa-router
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//注意：引入的方式 </span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">&quot;Hello koa&quot;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">&quot;新闻 page&quot;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//作用：启动路由 </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 作用： 这是官方文档的推荐用法,我们可以 看到 router.allowedMethods()用在了路由匹配 router.routes()之后,所以在当所有 路由中间件最后调用.此时根据 ctx.status 设置 response 响应头 </span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'starting at port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="get-传值"><a href="#get-传值" aria-hidden="true" class="header-anchor">#</a> get 传值</h3> <p>在 koa2 中 GET 传值通过 request 接收，但是接收的方法有两种：query 和 querystring。</p> <ul><li>query：返回的是格式化好的参数对象。</li> <li>querystring：返回的是请求字符串。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">&quot;Hello koa&quot;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/newscontent'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span>ctx<span class="token punctuation">.</span>url<span class="token punctuation">;</span> <span class="token comment">//从 request 中获取 GET 请求 </span>
  <span class="token keyword">let</span> request <span class="token operator">=</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">;</span> 
  <span class="token keyword">let</span> req_query <span class="token operator">=</span> request<span class="token punctuation">.</span>query<span class="token punctuation">;</span> 
  <span class="token keyword">let</span> req_querystring <span class="token operator">=</span> request<span class="token punctuation">.</span>querystring<span class="token punctuation">;</span> <span class="token comment">//从上下文中直接获取 </span>
  <span class="token keyword">let</span> ctx_query <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span> 
  <span class="token keyword">let</span> ctx_querystring <span class="token operator">=</span> ctx<span class="token punctuation">.</span>querystring<span class="token punctuation">;</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token punctuation">{</span> 
    url<span class="token punctuation">,</span> 
    req_query<span class="token punctuation">,</span> 
    req_querystring<span class="token punctuation">,</span> 
    ctx_query<span class="token punctuation">,</span> 
    ctx_querystring 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//作用：启动路由 </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//作用： 当请求出错时的处理逻辑 </span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'starting at port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="动态路由"><a href="#动态路由" aria-hidden="true" class="header-anchor">#</a> 动态路由</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//请求方式 http://域名/product/123 </span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/product/:aid'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{ aid: '123' } //获取动态路由的数据 </span>
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'这是商品页面'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="post"><a href="#post" aria-hidden="true" class="header-anchor">#</a> post</h3> <p>原生 Nodejs 获取 post 提交数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">functionparsePostData</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token function">returnnewPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
    <span class="token keyword">try</span><span class="token punctuation">{</span> 
      letpostdata<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
      ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
        postdata<span class="token operator">+=</span>data 
      <span class="token punctuation">}</span><span class="token punctuation">)</span> 
      ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token function">resolve</span><span class="token punctuation">(</span>postdata<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span> 
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>Koa 中 koa-bodyparser 中间件的使用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> install--savekoa-bodyparser
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">var</span> bodyParser<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">var</span> app<span class="token operator">=</span><span class="token function">newKoa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span> <span class="token comment">// 获取 post 提交的数据</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="中间件"><a href="#中间件" aria-hidden="true" class="header-anchor">#</a> 中间件</h2> <p>通俗的讲：中间件就是匹配路由之前或者匹配路由完成做的一系列的操作，我们就可以 把它叫做中间件。</p> <div class="tip custom-block"><p>在express中间件（Middleware）是一个函数，它可以访问请求对象（requestobject(req)） , 响应对象（responseobject(res)）, 和 web 应用中处理请求-响应循环流程中的中间件，一 般被命名为 next 的变量。在 Koa 中中间件和 express 有点类似。</p></div> <p>中间件的功能包括：</p> <ul><li>执行任何代码。</li> <li>修改请求和响应对象。</li> <li>终结请求-响应循环。</li> <li>调用堆栈中的下一个中间件。</li></ul> <div class="tip custom-block"><p>如果我的 get、post 回调函数中，没有 next 参数，那么就匹配上第一个路由，就不会往下匹 配了。如果想往下匹配的话，那么需要写 next()</p></div> <h3 id="应用级中间件"><a href="#应用级中间件" aria-hidden="true" class="header-anchor">#</a> 应用级中间件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">&quot;Hello koa&quot;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">&quot;新闻页面&quot;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//作用：启动路由 </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//作用： 当请求出错时的处理逻辑 </span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'starting at port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="路由中间件"><a href="#路由中间件" aria-hidden="true" class="header-anchor">#</a> 路由中间件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">&quot;Hello koa&quot;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="错误处理中间"><a href="#错误处理中间" aria-hidden="true" class="header-anchor">#</a> 错误处理中间</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>status<span class="token operator">==</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span> 
    ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">&quot;这是一个 404 页面&quot;</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="第三方中间件"><a href="#第三方中间件" aria-hidden="true" class="header-anchor">#</a> 第三方中间件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 静态资源中间件</span>
<span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> staticPath <span class="token operator">=</span> <span class="token string">'./static'</span><span class="token punctuation">;</span> 
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span> 
  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> __dirname<span class="token punctuation">,</span> staticPath<span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="koa-中间件的执行顺序"><a href="#koa-中间件的执行顺序" aria-hidden="true" class="header-anchor">#</a> Koa 中间件的执行顺序</h3> <p>Koa 的中间件和 Express 不同，Koa 选择了洋葱圈模型。
<a data-fancybox="" title="koa" href="/Technology/koa.jpg"><img src="/Technology/koa.jpg" alt="koa.jpg" title="koa"></a></p> <h2 id="koa-cookie"><a href="#koa-cookie" aria-hidden="true" class="header-anchor">#</a> Koa Cookie</h2> <p>1、Koa 中设置 Cookie 的值</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>value<span class="token punctuation">,</span><span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过options 设置 cookie name 的value:</p> <table><thead><tr><th style="text-align:center;">options名称</th> <th style="text-align:center;">options值</th></tr></thead> <tbody><tr><td style="text-align:center;">maxAge</td> <td style="text-align:center;">一个数字表示从 Date.now() 得到的毫秒数</td></tr> <tr><td style="text-align:center;">expires</td> <td style="text-align:center;">cookie 过期的Date</td></tr> <tr><td style="text-align:center;">path</td> <td style="text-align:center;">cookie 路径, 默认是'/'</td></tr> <tr><td style="text-align:center;">domain</td> <td style="text-align:center;">cookie 域名</td></tr> <tr><td style="text-align:center;">secure</td> <td style="text-align:center;">安全 cookie 默认 false，设置成 true 表示 只有 https 可以访问</td></tr> <tr><td style="text-align:center;">httpOnly</td> <td style="text-align:center;">是否只是服务器可访问 cookie, 默认是true</td></tr> <tr><td style="text-align:center;">overwrite</td> <td style="text-align:center;">一个布尔值，表示是否覆盖以前设置的同名 的 cookie(默认是 false). 如果是 true, 在同 一个请求中设置相同名称的所有 Cookie（不 管路径或域）是否在设置此 Cookie 时从 Set-Cookie 标头中过滤掉。</td></tr></tbody></table> <p>2、Koa 中获取 Cookie 的值</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3、Koa 中设置中文 Cookie</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">'hello, world!'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转换成base64字符 串：aGVsbG8sIHdvcmxkIQ==</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">'aGVsbG8sIHdvcmxkIQ=='</span><span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 还原base 64字符串：hello, world!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="session"><a href="#session" aria-hidden="true" class="header-anchor">#</a> Session</h2> <p>session 是另一种记录客户状态的机制，不同的是 Cookie 保存在客户端浏览器中，而 session 保存在服务器上。</p> <h3 id="session-的工作流程"><a href="#session-的工作流程" aria-hidden="true" class="header-anchor">#</a> Session 的工作流程</h3> <p>当浏览器访问服务器并发送第一次请求时，服务器端会创建一个session对象，生成一个类似于key,value的键值对， 然后将key(cookie)返回到浏览器(客户)端，浏览器下次再访问时，携带key(cookie)，找到对应的session(value)。 客户的信息都保存在session中</p> <h3 id="koa-session"><a href="#koa-session" aria-hidden="true" class="header-anchor">#</a> koa-session</h3> <p>1.安装 express-session</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> koa-session --save
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2.引入express-session</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3.设置官方文档提供的中间件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'some secret hurr'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  key<span class="token punctuation">:</span> <span class="token string">'koa:sess'</span><span class="token punctuation">,</span> <span class="token comment">//cookie key (default is koa:sess)</span>
  maxAge<span class="token punctuation">:</span> <span class="token number">86400000</span><span class="token punctuation">,</span> <span class="token comment">// cookie 的过期时间 maxAge in ms (default is 1 days)</span>
  overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否可以 overwrite (默认 default true)</span>
  httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//cookie 是否只有服务器端可以访问 httpOnly or not (default true)</span>
  signed<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//签名默认 true</span>
  rolling<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//在每次请求时强行设置 cookie，这将重置 cookie 过期时间（默认：false）</span>
  renew<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//(boolean) renew session when session is nearly expired,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>4.使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">;</span>  <span class="token comment">// 设置值 </span>
ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username  <span class="token comment">// 获取值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="cookie-和-session-区别"><a href="#cookie-和-session-区别" aria-hidden="true" class="header-anchor">#</a> Cookie 和 Session 区别</h3> <ol><li>cookie 数据存放在客户的浏览器上，session 数据放在服务器上。</li> <li>cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗 考虑到安全应当使用 session。</li> <li>session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能 考虑到减轻服务器性能方面，应当使用 COOKIE。</li> <li>单个 cookie 保存的数据不能超过 4K，很多浏览器都限制一个站点最多保存 20 个 cookie。</li></ol> <h2 id="koa-static-静态资源中间件"><a href="#koa-static-静态资源中间件" aria-hidden="true" class="header-anchor">#</a> koa-static 静态资源中间件</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 静态资源中间件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="koa2-cors-跨域"><a href="#koa2-cors-跨域" aria-hidden="true" class="header-anchor">#</a> koa2-cors 跨域</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa2-cors'</span><span class="token punctuation">)</span> <span class="token comment">// 跨域</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="koa-json"><a href="#koa-json" aria-hidden="true" class="header-anchor">#</a> koa-json</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-json'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="koa-logger"><a href="#koa-logger" aria-hidden="true" class="header-anchor">#</a> koa-logger</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-logger'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="koa-jwt-token中间件"><a href="#koa-jwt-token中间件" aria-hidden="true" class="header-anchor">#</a> koa-jwt token中间件</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-jwt'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// jwt token中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token punctuation">:</span> <span class="token string">'mds'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">{</span>path<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^\/mds\/login/</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="验证中间件"><a href="#验证中间件" aria-hidden="true" class="header-anchor">#</a> 验证中间件</h2> <p>aap.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> errorHandle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/errorHandle'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sendHandle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/sendHandle'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 验证中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">sendHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">errorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>sendHandle.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">sendHandle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理请求成功方法</span>
  <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">'请求成功'</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token punctuation">:</span> <span class="token string">'200'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">,</span>
        msg
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理请求失败方法</span>
  <span class="token keyword">const</span> <span class="token function-variable function">renderError</span> <span class="token operator">=</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">'请求失败'</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        msg
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>send <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>sendError <span class="token operator">=</span> <span class="token function">renderError</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> sendHandle<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>errorHandle.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> verify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>verify<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">errorHandle</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> ctx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>authorization
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> payload
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          payload <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'mds'</span><span class="token punctuation">)</span>
          ctx<span class="token punctuation">.</span>user <span class="token operator">=</span> payload
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'token verify fail:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span>
        ctx<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span><span class="token string">'401'</span><span class="token punctuation">,</span> <span class="token string">'页面登录已失效，请重新登录'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
          code<span class="token punctuation">:</span> <span class="token number">404</span><span class="token punctuation">,</span>
          msg<span class="token punctuation">:</span> <span class="token string">'404'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> errorHandle

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h2 id="sequelize"><a href="#sequelize" aria-hidden="true" class="header-anchor">#</a> sequelize</h2> <p>Sequelize是一个基于promise的关系型数据库ORM框架，这个库完全采用JavaScript开发并且能够用在Node.JS环境中，易于使用，支持多SQL方言(dialect)，。它当前支持MySQL,、MariaDB、SQLite、PostgreSQL、Sql Server 数据库。</p> <div class="tip custom-block"><p>对象-关系映射（Object/Relation Mapping，简称ORM）<br>
ORM方法论基于三个核心原则：</p> <ul><li>简单性：以最基本的形式建模数据。</li> <li>传达性：数据库结构被任何人都能理解的语言文档化。</li> <li>精确性：基于数据模型创建正确标准化了的结构。</li></ul> <p>ORM包括以下四部分：</p> <ul><li>一个对持久类对象进行CRUD操作的API；</li> <li>一个语言或API用来规定与类和类属性相关的查询；</li> <li>一个规定mapping metadata的工具；</li> <li>一种技术可以让ORM的实现同事务对象一起进行dirty checking, lazy association fetching以及其他的优化操作。</li></ul></div> <h3 id="sequelize-连接mysql"><a href="#sequelize-连接mysql" aria-hidden="true" class="header-anchor">#</a> sequelize 连接mysql</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span><span class="token string">'mds_node'</span><span class="token punctuation">,</span><span class="token string">'root'</span><span class="token punctuation">,</span><span class="token string">'root'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  host<span class="token punctuation">:</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
  dialect<span class="token punctuation">:</span><span class="token string">'mysql'</span><span class="token punctuation">,</span>
  define<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  pool<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    max<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    min<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    acquire<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    idle<span class="token punctuation">:</span> <span class="token number">10000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> sequelize<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="sequelize-auto-生成models"><a href="#sequelize-auto-生成models" aria-hidden="true" class="header-anchor">#</a> sequelize-auto 生成models</h3> <p>auto.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> SequelizeAuto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize-auto'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> auto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SequelizeAuto</span><span class="token punctuation">(</span><span class="token string">'mds'</span><span class="token punctuation">,</span> <span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    dialect<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    directory<span class="token punctuation">:</span> <span class="token string">'../models'</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
    additional<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      timestamps<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      underscored<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
auto<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>auto<span class="token punctuation">.</span>tables<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// table list</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>auto<span class="token punctuation">.</span>foreignKeys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// foreign key list</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="生成model关系模型"><a href="#生成model关系模型" aria-hidden="true" class="header-anchor">#</a> 生成model关系模型</h3> <p>createModelsExport.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span><span class="token string">'../models'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> models <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// 解析名称做成驼峰命名法</span>
files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!=</span> <span class="token string">'index.js'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> names <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">+=</span> names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> name<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token string">'./'</span> <span class="token operator">+</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 文件内容模板</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
const  Sequelize = require('sequelize');
const sequelize = require('../db/dbconfig')
// 数据库模型名称及路径
const models =</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>models<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
// 数据模型输出
models.forEach(item =&gt; {
    module.exports[item.name] = require(item.path)(sequelize, Sequelize)
})
</span><span class="token template-punctuation string">`</span></span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">&quot;../models/index.js&quot;</span><span class="token punctuation">,</span> template<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'创建成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="sequelize同步模型到数据库"><a href="#sequelize同步模型到数据库" aria-hidden="true" class="header-anchor">#</a> sequelize同步模型到数据库</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/connectDB'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token string">'./user'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Role <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token string">'./role'</span><span class="token punctuation">)</span>

<span class="token comment">// 模型之间的关系</span>
User<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Role<span class="token punctuation">,</span> <span class="token punctuation">{</span>through<span class="token punctuation">:</span> <span class="token string">'sys_user_roles'</span><span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span><span class="token string">'UserRoles'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Role<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span>through<span class="token punctuation">:</span> <span class="token string">'sys_user_roles'</span><span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span><span class="token string">'UserRoles'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 同步模型到数据库</span>
sequelize<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span>User <span class="token operator">=</span> User
exports<span class="token punctuation">.</span>Role <span class="token operator">=</span> Role
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="login生成token"><a href="#login生成token" aria-hidden="true" class="header-anchor">#</a> login生成token</h3> <p>controllers层<br>
jsonwebtoken生成token  由三部分组成<br>
bcrypt.hashSync加密</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> UserModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>User
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> salt <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">genSaltSync</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
  <span class="token keyword">const</span> userSigned <span class="token operator">=</span> <span class="token keyword">await</span> UserModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    where<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      username<span class="token punctuation">:</span> user<span class="token punctuation">.</span>username
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userSigned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token punctuation">:</span><span class="token number">500</span><span class="token punctuation">,</span>
      msg<span class="token punctuation">:</span><span class="token string">'用户不存在'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hashPwd <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hashPwd<span class="token punctuation">)</span> <span class="token comment">// 加密密码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> userSigned<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
        msg<span class="token punctuation">:</span> <span class="token string">'密码不正确'</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token punctuation">{</span>
        userId<span class="token punctuation">:</span> userSigned<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
        username<span class="token punctuation">:</span> userSigned<span class="token punctuation">.</span>username
      <span class="token punctuation">}</span>
      <span class="token comment">// jsonwebtoken生成token  由三部分组成</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        exp<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span>
        userId<span class="token punctuation">:</span> userSigned<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
        username<span class="token punctuation">:</span> userSigned<span class="token punctuation">.</span>username
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'mds'</span><span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        msg<span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span>
        list<span class="token punctuation">:</span> <span class="token punctuation">[</span>userSigned<span class="token punctuation">]</span><span class="token punctuation">,</span>
        Authorization<span class="token punctuation">:</span> token
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h3 id="基本sql语句"><a href="#基本sql语句" aria-hidden="true" class="header-anchor">#</a> 基本sql语句</h3> <table><thead><tr><th style="text-align:center;">sql</th> <th style="text-align:center;">orm</th></tr></thead> <tbody><tr><td style="text-align:center;">select</td> <td style="text-align:center;">findAll,findOne,findById,findOrCreate,findAndCountAll</td></tr> <tr><td style="text-align:center;">delete</td> <td style="text-align:center;">destroy</td></tr> <tr><td style="text-align:center;">update</td> <td style="text-align:center;">update</td></tr> <tr><td style="text-align:center;">insert</td> <td style="text-align:center;">create</td></tr> <tr><td style="text-align:center;">SELECT foo, bar ...</td> <td style="text-align:center;">Model.findAll({attributes: ['foo', 'bar']});</td></tr> <tr><td style="text-align:center;">SELECT foo, bar AS baz ...</td> <td style="text-align:center;">Model.findAll({attributes: ['foo', ['bar', 'baz']]});</td></tr> <tr><td style="text-align:center;">SELECT COUNT(hats) AS no_hats ...</td> <td style="text-align:center;">Model.findAll({attributes: [[sequelize.fn('COUNT', sequelize.col('hats')), 'no_hats']]});</td></tr> <tr><td style="text-align:center;">SELECT id, foo, bar, quz ...</td> <td style="text-align:center;">Model.findAll({attributes: {exclude: ['baz'] }});</td></tr></tbody></table> <h4 id="where"><a href="#where" aria-hidden="true" class="header-anchor">#</a> WHERE</h4> <table><thead><tr><th style="text-align:center;">sql</th> <th style="text-align:center;">orm</th></tr></thead> <tbody><tr><td style="text-align:center;">SELECT * FROM post WHERE authorId = 12 AND status = 'active'</td> <td style="text-align:center;">Post.findAll({where: { authorId: 2,status: 'active'}});</td></tr></tbody></table> <h4 id="operators"><a href="#operators" aria-hidden="true" class="header-anchor">#</a> Operators</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Post<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  updatedAt<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  where<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    deletedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      $ne<span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// UPDATE post SET updatedAt = null WHERE deletedAt NOT NULL;</span>

Post<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'char_length'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SELECT * FROM post WHERE char_length(status) = 6;</span>

<span class="token punctuation">{</span>
  rank<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    $or<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      $lt<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      $eq<span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// rank &lt; 1000 OR rank IS NULL</span>

<span class="token punctuation">{</span>
  createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    $lt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    $gt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// createdAt &lt; [timestamp] AND createdAt &gt; [timestamp]</span>

<span class="token punctuation">{</span>
  $or<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        $like<span class="token punctuation">:</span> <span class="token string">'Boat%'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      description<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        $like<span class="token punctuation">:</span> <span class="token string">'%boat%'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// title LIKE 'Boat%' OR description LIKE '%boat%'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><table><thead><tr><th style="text-align:center;">op</th> <th style="text-align:center;">define</th></tr></thead> <tbody><tr><td style="text-align:center;">$and: {a: 5}</td> <td style="text-align:center;">AND (a = 5)</td></tr> <tr><td style="text-align:center;">$or: [{a: 5}, {a: 6}]</td> <td style="text-align:center;">(a = 5 OR a = 6)</td></tr> <tr><td style="text-align:center;">$gt: 6,</td> <td style="text-align:center;">&gt; 6</td></tr> <tr><td style="text-align:center;">$gte: 6,</td> <td style="text-align:center;">&gt;= 6</td></tr> <tr><td style="text-align:center;">$lt: 10,</td> <td style="text-align:center;">&lt; 10</td></tr> <tr><td style="text-align:center;">$lte: 10,</td> <td style="text-align:center;">&lt;= 10</td></tr> <tr><td style="text-align:center;">$ne: 20,</td> <td style="text-align:center;">!= 20</td></tr> <tr><td style="text-align:center;">$between: [6, 10],</td> <td style="text-align:center;">BETWEEN 6 AND 10</td></tr> <tr><td style="text-align:center;">$notBetween: [11, 15],</td> <td style="text-align:center;">NOT BETWEEN 11 AND 15</td></tr> <tr><td style="text-align:center;">$in: [1, 2],</td> <td style="text-align:center;">IN [1, 2]</td></tr> <tr><td style="text-align:center;">$notIn: [1, 2],</td> <td style="text-align:center;">NOT IN [1, 2]</td></tr> <tr><td style="text-align:center;">$like: '%hat',</td> <td style="text-align:center;">LIKE '%hat'</td></tr> <tr><td style="text-align:center;">$notLike: '%hat'</td> <td style="text-align:center;">NOT LIKE '%hat'</td></tr> <tr><td style="text-align:center;">$iLike: '%hat'</td> <td style="text-align:center;">ILIKE '%hat' (case insensitive) (PG only)</td></tr> <tr><td style="text-align:center;">$notILike: '%hat'</td> <td style="text-align:center;">NOT ILIKE '%hat'  (PG only)</td></tr> <tr><td style="text-align:center;">$like: { $any: ['cat', 'hat']}</td> <td style="text-align:center;">LIKE ANY ARRAY['cat', 'hat'] - also works for iLike and notLike</td></tr> <tr><td style="text-align:center;">$overlap: [1, 2]</td> <td style="text-align:center;">&amp;&amp; [1, 2] (PG array overlap operator)</td></tr> <tr><td style="text-align:center;">$contains: [1, 2]</td> <td style="text-align:center;">@&gt; [1, 2] (PG array contains operator)</td></tr> <tr><td style="text-align:center;">$contained: [1, 2]</td> <td style="text-align:center;">&lt;@ [1, 2] (PG array contained by operator)</td></tr> <tr><td style="text-align:center;">$any: [2,3]</td> <td style="text-align:center;">ANY ARRAY[2, 3]::INTEGER (PG only)</td></tr> <tr><td style="text-align:center;">$col: 'user.organization_id'</td> <td style="text-align:center;">&quot;user&quot;.&quot;organization_id&quot;, with dialect specific column identifiers, PG in this example  --$col取表的字段</td></tr></tbody></table> <div class="warning custom-block"><p><code>tabel need primarykey:</code>如果没有，Sequlize会自己加个自增主键，可能引起错误</p></div> <div class="tip custom-block"><p><code>findOrCreate:</code>查到一个，查不到就新建</p></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code>models<span class="token punctuation">.</span>BrandReview<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          mem_id<span class="token punctuation">:</span> mem_id<span class="token punctuation">,</span>
          brand_id<span class="token punctuation">:</span> brand_id
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      defaults<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          score<span class="token punctuation">:</span> score <span class="token comment">//新建的数据</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token comment">//返回值为数组，[json,created] 第一位是查询或创建的数据，第二位标识是否新建</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="tip custom-block"><p><code>update:</code>返回值为数据，[2],数字代码改动记录数
<code>destroy:</code>返回数字，代表删除记录数</p></div> <h3 id="使用原生sql"><a href="#使用原生sql" aria-hidden="true" class="header-anchor">#</a> 使用原生sql</h3> <p>官网中代码例子</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//1</span>
sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  logging<span class="token punctuation">:</span> console<span class="token punctuation">.</span>log<span class="token punctuation">,</span>
  
  plain<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
 
  raw<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
 
  type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
<span class="token comment">//2</span>
sequelize
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> raw<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>projects<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//3</span>
sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects WHERE status = ?'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> replacements<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'active'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>projects<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//4</span>
sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects WHERE status = :status '</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> replacements<span class="token punctuation">:</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token string">'active'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>projects<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li><p>sequelize中提供了query函数，用于直接操作原生语句</p></li> <li><p>该函数将返回两个参数 - 结果数组和包含元数据的对象，对于mysql将是返一对象的两个引用。</p></li> <li><p>query函数的第二个参数，是一个对象，对象里面几个常用参数进行说明。</p> <ol><li>pain：如果plain为真，那么sequelize只返回第一个 记录结果集。如果为false，则返回所有记录。</li> <li>type：正在执行的查询的类型（也可以is hi更新哦，具体哪些去看官网api）。查询类型影响返回结果之前的格式化方式。</li> <li>raw：查询对类型是否有模型定义，如果您的查询没有模型定义，请将此设置为true。</li> <li>logging: console.log记录查询的函数 是否会为发送的每个SQL查询调用 到服务器。</li></ol></li> <li><p>对于查找条件where后面的字段</p> <ol><li>如果传递数组，?将按它们在数组中出现的顺序进行替换。</li> <li>如果传递了一个对象，:key则将替换该对象中的键。如果对象包含查询中未找到的键，会抛出查询异常。</li></ol></li> <li><p>对于替换where后面的变量，也可以使用in关键字从数组匹配，也可以使用通配符like%等 代码如下：</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//in关键字使用官网例子</span>
sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects WHERE status IN(:status) '</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> replacements<span class="token punctuation">:</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'active'</span><span class="token punctuation">,</span> <span class="token string">'inactive'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>projects<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//like通配符关键字使用官网例子</span>
sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM users WHERE name LIKE :search_name '</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> replacements<span class="token punctuation">:</span> <span class="token punctuation">{</span> search_name<span class="token punctuation">:</span> <span class="token string">'ben%'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>projects<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>查询的时候还可以直接传递model，如果传递模型，则返回的数据将是该模型的实例，上面其它字段也可以在这使用</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>sequelize
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">:</span> Projects<span class="token punctuation">,</span>
    mapToModel<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// 如果有任何映射字段，则在这里传递true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Each record will now be an instance of Project</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> sqlRank <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT userspk.avatar AS user_avatar, 
        userspk.gender AS user_gender, 
        userspk.nickname AS user_nickname,
        a.id AS pk_record_id,
        a.user_id, 
        a.answer_record, 
        a.pk_type, 
         MAX(score) AS score, 
        a.create_time
        FROM (select * from pkrecord  order by score desc,create_time asc) as a 
        INNER JOIN userspk AS userspk 
        ON a.user_id = userspk.user_id
        WHERE a.status = 1 
        AND a.pk_type = 'noreal' 
        AND a.subject_id = :subject_id
        GROUP BY user_id
        ORDER BY a.score DESC 
        LIMIT 3;</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">let</span> pkRankResult<span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlRank<span class="token punctuation">,</span>  <span class="token punctuation">{</span>
    replacements<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        subject_id<span class="token punctuation">:</span> subject_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2019-8-30 6:26:45 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-355bf788><div id="valine" data-v-355bf788></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-f9458a92 data-v-f9458a92><i class="iconfont reco-up" data-v-f9458a92></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8b298d71.js" defer></script><script src="/assets/js/3.1047f7fc.js" defer></script><script src="/assets/js/1.e9036eeb.js" defer></script><script src="/assets/js/12.a94480e8.js" defer></script>
  </body>
</html>
